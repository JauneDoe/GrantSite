<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Site Content Manager</title>
    <meta
      name="description"
      content="Private content manager for updating the Community Grants Initiative site."
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <script>
      if (sessionStorage.getItem("ownerAccess") !== "granted") {
        window.location.href = "login.html";
      }
    </script>
    <header class="site-header" style="position: sticky; top: 0; z-index: 100;">
      <nav class="nav">
        <span class="logo">
          <span class="logo-mark">CGI</span>
          <span class="logo-text">Admin Portal</span>
        </span>
        <div class="nav-actions">
          <a class="button button-ghost" href="index.html" target="_blank">View Live Site</a>
          <button class="button button-ghost" onclick="location.href='index.html'">Sign Out</button>
        </div>
      </nav>
    </header>

    <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <aside class="dashboard-sidebar">
            <nav class="dashboard-nav">
                <a class="dash-link active" onclick="switchTab('requests')">Client Requests</a>
                <a class="dash-link" onclick="switchTab('settings')">Settings</a>
                
                <hr style="border: 0; border-top: 1px solid var(--border); margin: 0.5rem 0;" />
                
                <a class="dash-link" href="editor.html" style="display: flex; justify-content: space-between; align-items: center;">
                    Website Editor 
                    <span style="font-size: 1.2em;">&rarr;</span>
                </a>
            </nav>
            
            <div style="margin-top: auto; padding-top: 2rem;">
                <div class="card" style="padding: 1rem; background: var(--surface); border: none;">
                    <small style="color: var(--muted); display: block; margin-bottom: 0.5rem;">Quick Stats</small>
                    <strong style="font-size: 1.2rem; display: block;" id="total-raised">$0</strong>
                    <small style="color: var(--primary);">Funds Secured</small>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="dashboard-main">
            
            <!-- VIEW 1: CLIENT REQUESTS (CRM) -->
            <div id="view-requests" class="dash-view active">
                <div class="section-heading" style="margin-bottom: 1.5rem;">
                    <h2>Client Requests</h2>
                    <p>Manage incoming grant applications and update their status.</p>
                </div>
                
                <div class="card" style="padding: 0; overflow: hidden;">
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; text-align: left;">
                            <thead style="background: #fdfdfd; border-bottom: 1px solid var(--border);">
                                <tr>
                                    <th style="padding: 1rem; font-size: 0.85rem; color: var(--muted);">Date</th>
                                    <th style="padding: 1rem; font-size: 0.85rem; color: var(--muted);">Client</th>
                                    <th style="padding: 1rem; font-size: 0.85rem; color: var(--muted);">Project</th>
                                    <th style="padding: 1rem; font-size: 0.85rem; color: var(--muted);">Amount</th>
                                    <th style="padding: 1rem; font-size: 0.85rem; color: var(--muted);">Status</th>
                                    <th style="padding: 1rem; font-size: 0.85rem; color: var(--muted);">Messages</th>
                                    <th style="padding: 1rem; font-size: 0.85rem; color: var(--muted);">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="crm-table-body">
                                <!-- JS will populate this -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW 2: SETTINGS -->
            <div id="view-settings" class="dash-view">
                 <div class="section-heading">
                    <h2>Admin Settings</h2>
                </div>
                <div class="card">
                    <p>Future account settings and password management will go here.</p>
                </div>
            </div>

        </main>
    </div>

    <!-- Message Modal -->
    <dialog id="msg-modal">
        <div class="modal-header">
            <h3 id="msg-client-name">Chat</h3>
            <button class="close-button" onclick="closeMessages()">&times;</button>
        </div>
        <div class="modal-body" id="msg-body">
            <!-- Messages go here -->
        </div>
        <div class="modal-footer">
            <input type="text" id="msg-input" class="chat-input" placeholder="Type a message..." onkeydown="if(event.key === 'Enter') sendMessage()">
            <button class="button button-primary" onclick="sendMessage()">Send</button>
        </div>
    </dialog>

    <script>
      // TAB SWITCHING LOGIC
      function switchTab(tabName) {
          // Hide all views
          document.querySelectorAll('.dash-view').forEach(el => el.classList.remove('active'));
          // Show selected view
          document.getElementById('view-' + tabName).classList.add('active');
          
          // Update nav state
          const navLinks = document.querySelectorAll('.dash-link'); 
          // Reset active class on buttons
           navLinks.forEach(el => {
               if(!el.getAttribute('href')) el.classList.remove('active');
           });

          if(tabName === 'requests') navLinks[0].classList.add('active');
          if(tabName === 'settings') navLinks[1].classList.add('active');
      }

      // CRM LOGIC: LOAD REQUESTS
      function loadCRM() {
          const tableBody = document.getElementById('crm-table-body');
          const requests = JSON.parse(localStorage.getItem("clientRequests") || "[]");
          
          // Load fundraising stats for sidebar
          const storedEdits = localStorage.getItem("siteEdits");
          const edits = storedEdits ? JSON.parse(storedEdits) : {};
           if(edits.fundraisingCurrent) {
               document.getElementById("total-raised").textContent = "$" + Number(edits.fundraisingCurrent).toLocaleString();
          }
          
          if (requests.length === 0) {
              tableBody.innerHTML = `<tr><td colspan="6" style="padding: 2rem; text-align: center; color: var(--muted);">No requests found yet.</td></tr>`;
              return;
          }

          tableBody.innerHTML = '';
          requests.forEach((req, index) => {
              const row = document.createElement('tr');
              row.style.borderBottom = "1px solid var(--border)";
              
              const optionsHtml = ['Received', 'Reviewing', 'Action Needed', 'Approved', 'Funded', 'Denied'].map(s => 
                  `<option value="${s}" ${req.status === s ? 'selected' : ''}>${s}</option>`
              ).join('');

              // Count messages
              let msgCount = req.messages ? req.messages.length : 0;
              if (req.adminNotes) msgCount++; // Count legacy note
              
              const btnText = msgCount > 0 ? `View Messages (${msgCount})` : "Start Chat";

              row.innerHTML = `
                  <td style="padding: 1rem;">${req.date}</td>
                  <td style="padding: 1rem; font-weight: 600;">${req.clientName}</td>
                  <td style="padding: 1rem;">${req.projectName}</td>
                  <td style="padding: 1rem;">$${Number(req.amount).toLocaleString()}</td>
                  <td style="padding: 1rem;">
                      <select onchange="updateStatus(${index}, this.value)" style="padding: 0.25rem; border-radius: 4px; border: 1px solid var(--border);">
                          ${optionsHtml}
                      </select>
                  </td>
                  <td style="padding: 1rem;">
                      <button class="button button-ghost" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;" onclick="openMessages(${index})">
                        ${btnText}
                      </button>
                  </td>
                  <td style="padding: 1rem;">
                      <button onclick="deleteRequest(${index})" style="color: #dc2626; background: none; border: none; cursor: pointer; font-size: 0.8rem; text-decoration: underline;">Delete</button>
                  </td>
              `;
              tableBody.appendChild(row);
          });
      }

      // CHAT LOGIC
      let currentReqIndex = -1;

      function openMessages(index) {
          currentReqIndex = index;
          const requests = JSON.parse(localStorage.getItem("clientRequests") || "[]");
          const req = requests[index];
          const modal = document.getElementById('msg-modal');
          const body = document.getElementById('msg-body');
          
          document.getElementById('msg-client-name').textContent = "Chat with " + req.clientName;
          body.innerHTML = '';

          // Migration: Show legacy admin note if exists
          let msgs = req.messages || [];
          if (msgs.length === 0 && req.adminNotes) {
             msgs = [{ sender: 'Admin', text: req.adminNotes, time: req.date }];
             // We don't save this migration permanently to avoid dupes unless they send a new msg, 
             // but strictly for display it's fine.
          }

          if (msgs.length === 0) {
              body.innerHTML = `<p style="text-align:center; color: var(--muted); padding: 1rem;">No messages yet. Start the conversation!</p>`;
          } else {
              msgs.forEach(m => {
                 const isMe = m.sender === 'Admin';
                 const div = document.createElement('div');
                 div.className = `message ${isMe ? 'sent' : 'received'}`;
                 div.innerHTML = `
                    ${m.text}
                    <span class="message-meta">${m.time}</span>
                 `;
                 body.appendChild(div);
              });
          }
          
          modal.showModal();
          // Scroll to bottom
          body.scrollTop = body.scrollHeight;
      }

      function closeMessages() {
          document.getElementById('msg-modal').close();
          currentReqIndex = -1;
      }

      function sendMessage() {
          if (currentReqIndex === -1) return;
          
          const input = document.getElementById('msg-input');
          const text = input.value.trim();
          if (!text) return;

          const requests = JSON.parse(localStorage.getItem("clientRequests") || "[]");
          const req = requests[currentReqIndex];
          
          if (!req.messages) req.messages = [];
          
          // Legacy migration on first write
          if (req.messages.length === 0 && req.adminNotes) {
              req.messages.push({ sender: 'Admin', text: req.adminNotes, time: req.date });
              delete req.adminNotes; // Clear legacy
          }

          const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          req.messages.push({
              sender: 'Admin',
              text: text,
              time: now
          });

          localStorage.setItem("clientRequests", JSON.stringify(requests));
          input.value = '';
          
          // Reload view
          openMessages(currentReqIndex);
          loadCRM(); // Update button count
      }

      function updateStatus(index, newStatus) {

      function deleteRequest(index) {
          if (confirm("Are you sure you want to delete this record?")) {
              const requests = JSON.parse(localStorage.getItem("clientRequests") || "[]");
              requests.splice(index, 1);
              localStorage.setItem("clientRequests", JSON.stringify(requests));
              loadCRM();
          }
      }

      // Initialize
      loadCRM();
    </script>
  </body>
</html>
