<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Site Content Manager</title>
    <meta
      name="description"
      content="Private content manager for updating the Community Grants Initiative site."
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <script>
      if (sessionStorage.getItem("ownerAccess") !== "granted") {
        window.location.href = "login.html";
      }
    </script>
    <header class="site-header" style="position: sticky; top: 0; z-index: 100;">
      <nav class="nav">
        <span class="logo">
          <span class="logo-mark">CGI</span>
          <span class="logo-text">Admin Portal</span>
        </span>
        <div class="nav-actions">
          <a class="button button-ghost" href="index.html" target="_blank">View Live Site</a>
          <button class="button button-ghost" onclick="location.href='index.html'">Sign Out</button>
        </div>
      </nav>
    </header>

    <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <aside class="dashboard-sidebar">
            <nav class="dashboard-nav">
                <a class="dash-link active" onclick="switchTab('requests')">Client Requests</a>
                <a class="dash-link" onclick="switchTab('editor')">Website Editor</a>
                <a class="dash-link" onclick="switchTab('settings')">Settings</a>
            </nav>
            
            <div style="margin-top: auto; padding-top: 2rem;">
                <div class="card" style="padding: 1rem; background: var(--surface); border: none;">
                    <small style="color: var(--muted); display: block; margin-bottom: 0.5rem;">Quick Stats</small>
                    <strong style="font-size: 1.2rem; display: block;" id="total-raised">$0</strong>
                    <small style="color: var(--primary);">Funds Secured</small>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="dashboard-main">
            
            <!-- VIEW 1: CLIENT REQUESTS (CRM) -->
            <div id="view-requests" class="dash-view active">
                <div class="section-heading" style="margin-bottom: 1.5rem;">
                    <h2>Client Requests</h2>
                    <p>Manage incoming grant applications and update their status.</p>
                </div>
                
                <div class="card" style="padding: 0; overflow: hidden;">
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; text-align: left;">
                            <thead style="background: #fdfdfd; border-bottom: 1px solid var(--border);">
                                <tr>
                                    <th style="padding: 1rem; font-size: 0.85rem; color: var(--muted);">Date</th>
                                    <th style="padding: 1rem; font-size: 0.85rem; color: var(--muted);">Client</th>
                                    <th style="padding: 1rem; font-size: 0.85rem; color: var(--muted);">Project</th>
                                    <th style="padding: 1rem; font-size: 0.85rem; color: var(--muted);">Amount</th>
                                    <th style="padding: 1rem; font-size: 0.85rem; color: var(--muted);">Status</th>
                                    <th style="padding: 1rem; font-size: 0.85rem; color: var(--muted);">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="crm-table-body">
                                <!-- JS will populate this -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW 2: WEBSITE EDITOR (CMS) -->
            <div id="view-editor" class="dash-view">
                <div class="section-heading">
                    <h2>Website Editor</h2>
                    <p>Update text, images, and colors on the landing page.</p>
                </div>

                <form class="owner-form card" id="owner-form">
                    <!-- BRANDING -->
                    <details open style="margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem;">
                        <summary style="font-weight: 700; cursor: pointer; margin-bottom: 1rem;">Branding & Navigation</summary>
                        <div class="owner-grid">
                            <div class="form-field">
                                <label for="logoMark">Logo initials</label>
                                <input id="logoMark" data-edit-key="logoMark" value="CGI" />
                            </div>
                            <div class="form-field">
                                <label for="logoText">Logo text</label>
                                <input id="logoText" data-edit-key="logoText" value="Community Grants Initiative" />
                            </div>
                        </div>
                    </details>

                    <!-- FUNDRAISING -->
                    <details open style="margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem;">
                        <summary style="font-weight: 700; cursor: pointer; margin-bottom: 1rem;">Success Tracker</summary>
                         <p class="form-help">
                          Option 1: Enter values manually.<br>
                          Option 2: Paste a "Published to Web" Google Sheet CSV link.
                        </p>
                        <div class="owner-grid">
                           <div class="form-field">
                            <label for="fundraisingCurrent">Current Verified ($)</label>
                            <input type="number" id="fundraisingCurrent" data-edit-key="fundraisingCurrent" placeholder="e.g. 50000" />
                           </div>
                           <div class="form-field">
                            <label for="fundraisingGoal">Target Amount ($)</label>
                            <input type="number" id="fundraisingGoal" data-edit-key="fundraisingGoal" placeholder="e.g. 100000" />
                           </div>
                           <div class="form-field full-width">
                            <label for="fundraisingSheetUrl">Google Sheet CSV Link</label>
                            <input id="fundraisingSheetUrl" data-edit-key="fundraisingSheetUrl" placeholder="https://docs.google.com/.../pub?output=csv" />
                           </div>
                        </div>
                    </details>

                    <!-- COLORS -->
                    <details style="margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem;">
                        <summary style="font-weight: 700; cursor: pointer; margin-bottom: 1rem;">Theme & Colors</summary>
                        <div class="owner-grid">
                          <div class="form-field">
                            <label for="themeBg">Background Color</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                              <input type="color" id="themeBg" data-edit-key="themeBg" value="#fffaf6" style="height: 40px; width: 60px; padding: 0;" />
                            </div>
                          </div>
                          <!-- Add other color fields if needed, simplified for this view -->
                          <div class="form-field">
                             <label for="themePrimary">Primary Color</label>
                             <input type="color" id="themePrimary" data-edit-key="themePrimary" value="#d97706" style="height: 40px; width: 60px; padding: 0;" />
                          </div>
                        </div>
                    </details>
                    
                    <!-- HERO TEXT (Condensed) -->
                    <details style="margin-bottom: 1rem;">
                        <summary style="font-weight: 700; cursor: pointer; margin-bottom: 1rem;">Hero Section Text</summary>
                         <div class="owner-grid">
                              <div class="form-field full-width">
                                <label for="heroTitle">Main Headline</label>
                                <textarea id="heroTitle" rows="2" data-edit-key="heroTitle">We connect resources to the people and places that need them most.</textarea>
                              </div>
                               <div class="form-field full-width">
                                <label for="heroSubtitle">Subtitle</label>
                                <textarea id="heroSubtitle" rows="2" data-edit-key="heroSubtitle">Our mission is... so every community can thrive.</textarea>
                              </div>
                         </div>
                    </details>

                    <div class="owner-actions" style="position: sticky; bottom: 1rem; background: white; padding: 1rem; border-top: 1px solid var(--border); box-shadow: 0 -4px 12px rgba(0,0,0,0.05); z-index: 50;">
                      <button class="button button-primary" type="submit">Save Changes to Site</button>
                      <button class="button button-ghost" type="button" id="reset-edits">Reset Defaults</button>
                    </div>
                </form>
            </div>

            <!-- VIEW 3: SETTINGS -->
            <div id="view-settings" class="dash-view">
                 <div class="section-heading">
                    <h2>Admin Settings</h2>
                </div>
                <div class="card">
                    <p>Future account settings and password management will go here.</p>
                </div>
            </div>

        </main>
    </div>

    <script>
      // TAB SWITCHING LOGIC
      function switchTab(tabName) {
          // Hide all views
          document.querySelectorAll('.dash-view').forEach(el => el.classList.remove('active'));
          // Show selected view
          document.getElementById('view-' + tabName).classList.add('active');
          
          // Update nav state
          document.querySelectorAll('.dash-link').forEach(el => el.classList.remove('active'));
          // Simple visual active state (index based for simplicity or match text)
          const links = document.querySelectorAll('.dash-link');
          if(tabName === 'requests') links[0].classList.add('active');
          if(tabName === 'editor') links[1].classList.add('active');
          if(tabName === 'settings') links[2].classList.add('active');
      }

      // CRM LOGIC: LOAD REQUESTS
      function loadCRM() {
          const tableBody = document.getElementById('crm-table-body');
          const requests = JSON.parse(localStorage.getItem("clientRequests") || "[]");
          
          if (requests.length === 0) {
              tableBody.innerHTML = `<tr><td colspan="6" style="padding: 2rem; text-align: center; color: var(--muted);">No requests found yet.</td></tr>`;
              return;
          }

          tableBody.innerHTML = '';
          requests.forEach((req, index) => {
              const row = document.createElement('tr');
              row.style.borderBottom = "1px solid var(--border)";
              
              const statusOptions = ['Received', 'Reviewing', 'Approved', 'Funded', 'Denied'];
              let optionsHtml = statusOptions.map(s => 
                  `<option value="${s}" ${req.status === s ? 'selected' : ''}>${s}</option>`
              ).join('');

              row.innerHTML = `
                  <td style="padding: 1rem;">${req.date}</td>
                  <td style="padding: 1rem; font-weight: 600;">${req.clientName}</td>
                  <td style="padding: 1rem;">${req.projectName}</td>
                  <td style="padding: 1rem;">$${Number(req.amount).toLocaleString()}</td>
                  <td style="padding: 1rem;">
                      <select onchange="updateStatus(${index}, this.value)" style="padding: 0.25rem; border-radius: 4px; border: 1px solid var(--border);">
                          ${optionsHtml}
                      </select>
                  </td>
                  <td style="padding: 1rem;">
                      <button onclick="deleteRequest(${index})" style="color: #dc2626; background: none; border: none; cursor: pointer; font-size: 0.8rem; text-decoration: underline;">Delete</button>
                  </td>
              `;
              tableBody.appendChild(row);
          });
      }

      function updateStatus(index, newStatus) {
          const requests = JSON.parse(localStorage.getItem("clientRequests") || "[]");
          if (requests[index]) {
              requests[index].status = newStatus;
              localStorage.setItem("clientRequests", JSON.stringify(requests));
              // Optional: Show toast notification
          }
      }

      function deleteRequest(index) {
          if (confirm("Are you sure you want to delete this record?")) {
              const requests = JSON.parse(localStorage.getItem("clientRequests") || "[]");
              requests.splice(index, 1);
              localStorage.setItem("clientRequests", JSON.stringify(requests));
              loadCRM();
          }
      }

      // Initialize
      loadCRM();


      // SITE EDITOR LOGIC (Existing Code Adapted)
      const form = document.getElementById("owner-form");
      const resetButton = document.getElementById("reset-edits");
      const storedEdits = localStorage.getItem("siteEdits");
      const edits = storedEdits ? JSON.parse(storedEdits) : {};
      
      // Update quick stat
      if(edits.fundraisingCurrent) {
           document.getElementById("total-raised").textContent = "$" + Number(edits.fundraisingCurrent).toLocaleString();
      }

      document.querySelectorAll("[data-edit-key]").forEach((input) => {
        const key = input.dataset.editKey;
        if (Object.prototype.hasOwnProperty.call(edits, key)) {
          input.value = edits[key];
        }
      });

      form.addEventListener("submit", (event) => {
        event.preventDefault();
        const payload = {};
        document.querySelectorAll("[data-edit-key]").forEach((input) => {
          payload[input.dataset.editKey] = input.value.trim();
        });
        localStorage.setItem("siteEdits", JSON.stringify(payload));
        alert("Changes saved. Open the homepage to review updates.");
      });

      resetButton.addEventListener("click", () => {
        if(confirm("Reset all text and colors to original defaults?")) {
            localStorage.removeItem("siteEdits");
            location.reload();
        }
      });
    </script>
  </body>
</html>
