<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Site Content Manager</title>
    <meta
      name="description"
      content="Private content manager for updating the Community Grants Initiative site."
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <script>
      if (sessionStorage.getItem("ownerAccess") !== "granted") {
        window.location.href = "login.html";
      }
    </script>
    <header class="site-header" style="position: sticky; top: 0; z-index: 100;">
      <nav class="nav">
        <span class="logo">
          <span class="logo-mark">CGI</span>
          <span class="logo-text">Admin Portal</span>
        </span>
        <div class="nav-actions">
          <a class="button button-ghost" href="index.html" target="_blank">View Live Site</a>
          <button class="button button-ghost" onclick="location.href='index.html'">Sign Out</button>
        </div>
      </nav>
    </header>

    <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <aside class="dashboard-sidebar">
            <nav class="dashboard-nav">
                <a class="dash-link active" onclick="switchTab('requests')">Client Requests</a>
                <a class="dash-link" onclick="switchTab('messages')" id="admin-nav-msgs">Messages</a>
                <a class="dash-link" onclick="switchTab('settings')">Settings</a>
                
                <hr style="border: 0; border-top: 1px solid var(--border); margin: 0.5rem 0;" />
                
                <a class="dash-link" href="editor.html" style="display: flex; justify-content: space-between; align-items: center;">
                    Website Editor 
                    <span style="font-size: 1.2em;">&rarr;</span>
                </a>
            </nav>
            
            <div style="margin-top: auto; padding-top: 2rem;">
                <div class="card" style="padding: 1rem; background: var(--surface); border: none;">
                    <small style="color: var(--muted); display: block; margin-bottom: 0.5rem;">Quick Stats</small>
                    <strong style="font-size: 1.2rem; display: block;" id="total-raised">$0</strong>
                    <small style="color: var(--primary);">Funds Secured</small>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="dashboard-main">
            
            <!-- VIEW 1: CLIENT REQUESTS (CRM) -->
            <div id="view-requests" class="dash-view active">
                <div class="section-heading" style="margin-bottom: 1.5rem;">
                    <h2>Client Requests</h2>
                    <p>Manage incoming grant applications and update their status.</p>
                </div>
                
                <div class="card" style="padding: 0; overflow: hidden;">
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; text-align: left;">
                            <thead style="background: #fdfdfd; border-bottom: 1px solid var(--border);">
                                <tr>
                                    <th style="padding: 1rem; font-size: 0.85rem; color: var(--muted);">Date</th>
                                    <th style="padding: 1rem; font-size: 0.85rem; color: var(--muted);">Client</th>
                                    <th style="padding: 1rem; font-size: 0.85rem; color: var(--muted);">Project</th>
                                    <th style="padding: 1rem; font-size: 0.85rem; color: var(--muted);">Amount</th>
                                    <th style="padding: 1rem; font-size: 0.85rem; color: var(--muted);">Status</th>
                                    <th style="padding: 1rem; font-size: 0.85rem; color: var(--muted);">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="crm-table-body">
                                <!-- JS will populate this -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW 2: MESSAGES -->
            <div id="view-messages" class="dash-view">
                 <div class="section-heading">
                    <h2>Message Center</h2>
                    <p>Direct communication with clients.</p>
                </div>
                <!-- Layout: Sidebar list of clients | Main chat window -->
                <div class="card" style="display: grid; grid-template-columns: 250px 1fr; height: 60vh; padding: 0; overflow: hidden;">
                    <!-- List -->
                    <div style="border-right: 1px solid var(--border); overflow-y: auto; background: #fafafa;">
                        <h4 style="padding: 1rem; border-bottom: 1px solid var(--border); margin: 0; position: sticky; top: 0; background: #fafafa;">Clients</h4>
                        <div id="msg-client-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <!-- Chat Area -->
                    <div style="display: flex; flex-direction: column; height: 100%; overflow: hidden;">
                         <div id="chat-header" style="padding: 1rem; border-bottom: 1px solid var(--border); font-weight: 600; background: #fff;">
                             Select a client to chat
                         </div>
                         <div id="chat-window" style="flex: 1; padding: 1.5rem 1.5rem 0.5rem; overflow-y: auto; background: var(--surface); display: flex; flex-direction: column; gap: 1rem;">
                             <!-- Messages -->
                         </div>
                         <div id="admin-typing-indicator" class="typing-indicator">Client is typing...</div>
                         <div style="padding: 1rem; border-top: 1px solid var(--border); background: #fff; display: flex; gap: 0.5rem; align-items: center;">
                             <button id="admin-file-btn" class="button button-ghost" style="padding: 0.5rem 0.75rem;" disabled onclick="document.getElementById('admin-file-input').click()" title="Upload File">
                                ðŸ“Ž
                             </button>
                             <input type="file" id="admin-file-input" style="display: none;" onchange="handleAdminFileUpload(this)">
                             <input id="admin-chat-input" type="text" class="chat-input" disabled placeholder="Select a client first..." onkeydown="if(event.key === 'Enter') sendAdminMessage()">
                             <button id="admin-chat-send" class="button button-primary" disabled onclick="sendAdminMessage()">Send</button>
                         </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 3: SETTINGS -->
            <div id="view-settings" class="dash-view">
                 <div class="section-heading">
                    <h2>Admin Settings</h2>
                </div>
                <div class="card">
                    <p>Future account settings and password management will go here.</p>
                </div>
            </div>

        </main>
    </div>

    <script>
      // TAB SWITCHING LOGIC
      function switchTab(tabName) {
          // Hide all views
          document.querySelectorAll('.dash-view').forEach(el => el.classList.remove('active'));
          // Show selected view
          document.getElementById('view-' + tabName).classList.add('active');
          
          // Update nav state
          const navLinks = document.querySelectorAll('.dash-link'); 
          // Reset active class on buttons
           navLinks.forEach(el => {
               if(!el.getAttribute('href')) el.classList.remove('active');
           });

          if(tabName === 'requests') navLinks[0].classList.add('active');
          if(tabName === 'messages') {
              navLinks[1].classList.add('active');
              loadMessageClients();
          }
          if(tabName === 'settings') navLinks[2].classList.add('active');
      }

      // MESSAGING LOGIC
      let activeChatClient = null;

      function loadMessageClients() {
          const list = document.getElementById('msg-client-list');
          list.innerHTML = '';
          
          // Get unique clients from requests
          const requests = JSON.parse(localStorage.getItem("clientRequests") || "[]");
          const clients = [...new Set(requests.map(r => r.clientName))];
          
          if (clients.length === 0) {
              list.innerHTML = `<div style="padding: 1rem; color: var(--muted); font-size: 0.9rem;">No clients found.</div>`;
              return;
          }

          const allMsgs = JSON.parse(localStorage.getItem("siteMessages") || "{}");
          
          clients.forEach(client => {
              const div = document.createElement('div');
              div.style.padding = '0.75rem 1rem';
              div.style.cursor = 'pointer';
              div.style.borderBottom = '1px solid var(--border)';
              div.style.fontSize = '0.9rem';
              div.style.display = 'flex';
              div.style.justifyContent = 'space-between';
              div.style.alignItems = 'center';
              div.textContent = client;
              
              // Unread Badge
              const clientMsgs = allMsgs[client] || [];
              const unreadCount = clientMsgs.filter(m => m.sender === 'Client' && !m.read).length;
              if(unreadCount > 0) {
                  div.innerHTML += `<span class="badge">${unreadCount}</span>`;
              }

              div.onclick = () => openAdminChat(client);
              
              if(activeChatClient === client) {
                  div.style.background = '#eef2ff';
                  div.style.fontWeight = '600';
              } else {
                  div.onmouseover = () => div.style.background = '#eee';
                  div.onmouseout = () => div.style.background = 'transparent';
              }
              
              list.appendChild(div);
          });
      }

      function openAdminChat(clientName) {
          activeChatClient = clientName;
          document.getElementById('chat-header').textContent = "Chat with " + clientName;
          document.getElementById('admin-chat-input').disabled = false;
          document.getElementById('admin-chat-send').disabled = false;
          document.getElementById('admin-file-btn').disabled = false;
          
          // Mark as read
          const allMsgs = JSON.parse(localStorage.getItem("siteMessages") || "{}");
          if(allMsgs[clientName]) {
             allMsgs[clientName].forEach(m => {
                 if(m.sender === 'Client') m.read = true;
             });
             localStorage.setItem("siteMessages", JSON.stringify(allMsgs));
          }

          loadMessageClients(); // Re-render list to clear badge
          renderChatMessages();
      }

      function renderChatMessages() {
          if(!activeChatClient) return;
          
          const window = document.getElementById('chat-window');
          const allMsgs = JSON.parse(localStorage.getItem("siteMessages") || "{}");
          const msgs = allMsgs[activeChatClient] || [];
          
          window.innerHTML = '';
          if(msgs.length === 0) {
              window.innerHTML = `<p style="color:var(--muted); text-align: center; margin-top: 2rem;">No messages yet. Say hello!</p>`;
          }
          
          msgs.forEach(m => {
              const isMe = m.sender === 'Admin';
              const div = document.createElement('div');
              div.className = `message ${isMe ? 'sent' : 'received'}`;
              div.innerHTML = `${m.text} <span class="message-meta">${m.time}</span>`;
              window.appendChild(div);
          });
          
           window.scrollTop = window.scrollHeight;
      }

      // Typing Logic
      let typingTimeout;
      const adminInput = document.getElementById('admin-chat-input');
      
      adminInput.addEventListener('input', () => {
          if(!activeChatClient) return;
          localStorage.setItem('typing_' + activeChatClient + '_admin', 'true');
          clearTimeout(typingTimeout);
          typingTimeout = setTimeout(() => {
             localStorage.setItem('typing_' + activeChatClient + '_admin', 'false');
          }, 1500);
      });
      
      // Listen for client typing
      window.addEventListener('storage', (e) => {
          if(!activeChatClient) return;
          
          // Refresh messages if storage changed (sync chat)
          if(e.key === 'siteMessages') {
             // Only update if we're not the one who wrote it (avoid double render glitch, though renderChat is safe)
             renderChatMessages();
             loadMessageClients(); // Update badges for others
          }

          // Typing indicator
          if (e.key === 'typing_' + activeChatClient + '_client') {
              const indicator = document.getElementById('admin-typing-indicator');
              if(e.newValue === 'true') indicator.classList.add('active');
              else indicator.classList.remove('active');
          }
      });
      
      // Polling for same-tab demo purposes 
      setInterval(() => {
         updateAdminGlobalBadge(); // Always check global
         
         if(!activeChatClient) return;
         if(localStorage.getItem('typing_' + activeChatClient + '_client') === 'true') {
             document.getElementById('admin-typing-indicator').classList.add('active');
         } else {
             document.getElementById('admin-typing-indicator').classList.remove('active');
         }
         // Auto-reload badges/messages
         const currentMsgs = localStorage.getItem("siteMessages");
         if (currentMsgs !== window.lastKnownMsgs) {
             window.lastKnownMsgs = currentMsgs;
             loadMessageClients();
             renderChatMessages();
         }
      }, 1000);

      function updateAdminGlobalBadge() {
          const allMsgs = JSON.parse(localStorage.getItem("siteMessages") || "{}");
          let totalUnread = 0;
          
          Object.values(allMsgs).forEach(clientMsgs => {
              totalUnread += clientMsgs.filter(m => m.sender === 'Client' && !m.read).length;
          });
          
          const link = document.getElementById('admin-nav-msgs');
          link.innerHTML = `Messages ${totalUnread > 0 ? `<span class="badge" style="display: inline-block; margin-left: 0.5rem;">${totalUnread}</span>` : ''}`;
      }

      function sendAdminMessage() {
          if(!activeChatClient) return;
          const input = document.getElementById('admin-chat-input');
          const text = input.value.trim();
          if(!text) return;
          
          saveAdminMsg(text);
          input.value = '';
          localStorage.setItem('typing_' + activeChatClient + '_admin', 'false'); // Stop typing immediately
      }

      function handleAdminFileUpload(input) {
          if (input.files && input.files[0] && activeChatClient) {
                const file = input.files[0];
                const msg = `Shared a file: <br><a href="#" style="text-decoration: underline;">ðŸ“„ ${file.name}</a>`;
                saveAdminMsg(msg);
                input.value = '';
          }
      }

      function saveAdminMsg(text) {
          const allMsgs = JSON.parse(localStorage.getItem("siteMessages") || "{}");
          if(!activeChatClient) return;
          if(!allMsgs[activeChatClient]) allMsgs[activeChatClient] = [];
          
          const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          allMsgs[activeChatClient].push({ sender: 'Admin', text: text, time: now, read: false }); // Sent as unread
          
          localStorage.setItem("siteMessages", JSON.stringify(allMsgs));
          renderChatMessages();
      }

      // CRM LOGIC: LOAD REQUESTS
      function loadCRM() {
          const tableBody = document.getElementById('crm-table-body');
          const requests = JSON.parse(localStorage.getItem("clientRequests") || "[]");
          
          // Load fundraising stats for sidebar
          const storedEdits = localStorage.getItem("siteEdits");
          const edits = storedEdits ? JSON.parse(storedEdits) : {};
           if(edits.fundraisingCurrent) {
               document.getElementById("total-raised").textContent = "$" + Number(edits.fundraisingCurrent).toLocaleString();
          }
          
          if (requests.length === 0) {
              tableBody.innerHTML = `<tr><td colspan="6" style="padding: 2rem; text-align: center; color: var(--muted);">No requests found yet.</td></tr>`;
              return;
          }

          tableBody.innerHTML = '';
          requests.forEach((req, index) => {
              const row = document.createElement('tr');
              row.style.borderBottom = "1px solid var(--border)";
              
              const statusOptions = ['Received', 'Reviewing', 'Approved', 'Funded', 'Denied'];
              let optionsHtml = statusOptions.map(s => 
                  `<option value="${s}" ${req.status === s ? 'selected' : ''}>${s}</option>`
              ).join('');

              row.innerHTML = `
                  <td style="padding: 1rem;">${req.date}</td>
                  <td style="padding: 1rem; font-weight: 600;">${req.clientName}</td>
                  <td style="padding: 1rem;">${req.projectName}</td>
                  <td style="padding: 1rem;">$${Number(req.amount).toLocaleString()}</td>
                  <td style="padding: 1rem;">
                      <select onchange="updateStatus(${index}, this.value)" style="padding: 0.25rem; border-radius: 4px; border: 1px solid var(--border);">
                          ${optionsHtml}
                      </select>
                  </td>
                  <td style="padding: 1rem;">
                      <button onclick="deleteRequest(${index})" style="color: #dc2626; background: none; border: none; cursor: pointer; font-size: 0.8rem; text-decoration: underline;">Delete</button>
                  </td>
              `;
              tableBody.appendChild(row);
          });
      }

      function updateStatus(index, newStatus) {
          const requests = JSON.parse(localStorage.getItem("clientRequests") || "[]");
          if (requests[index]) {
              requests[index].status = newStatus;
              localStorage.setItem("clientRequests", JSON.stringify(requests));
              // Optional: Show toast notification
          }
      }

      function deleteRequest(index) {
          if (confirm("Are you sure you want to delete this record?")) {
              const requests = JSON.parse(localStorage.getItem("clientRequests") || "[]");
              requests.splice(index, 1);
              localStorage.setItem("clientRequests", JSON.stringify(requests));
              loadCRM();
          }
      }

      // Initialize
      loadCRM();
      updateAdminGlobalBadge();
    </script>
  </body>
</html>
