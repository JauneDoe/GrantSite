<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Client Dashboard</title>
    <meta name="description" content="Track your grant applications." />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <script>
      if (sessionStorage.getItem("clientAccess") !== "granted") {
        window.location.href = "login.html";
      }
    </script>
    <header class="site-header">
      <nav class="nav">
        <span class="logo">
          <span class="logo-mark">CGI</span>
          <span class="logo-text">Client Portal</span>
        </span>
        <div class="nav-actions">
            <span style="font-size: 0.9rem; margin-right: 1rem;">Welcome, <span id="user-name">Client</span></span>
          <a class="button button-ghost" href="index.html">Sign Out</a>
        </div>
      </nav>
    </header>

    <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <aside class="dashboard-sidebar">
            <nav class="dashboard-nav">
                <a class="dash-link active" onclick="switchClientTab('dashboard')">My Dashboard</a>
                <a class="dash-link" onclick="switchClientTab('messages')" id="nav-msgs">
                    Message Center
                </a>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="dashboard-main">
            <!-- TAB 1: DASHBOARD -->
            <div id="view-dashboard" class="dash-view active">
                <div class="section-heading">
                    <h2>Grant Applications</h2>
                    <p>Manage your funding requests and track status updates.</p>
                </div>
      <div class="grid">
        <!-- Status Card -->
        <div class="card" style="grid-column: 1 / -1;">
             <h3>Active Applications</h3>
             <div style="overflow-x: auto; margin-top: 1rem;">
                <table style="width: 100%; border-collapse: collapse; text-align: left;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border);">
                            <th style="padding: 0.75rem 0.5rem; color: var(--muted); font-weight: 600; font-size: 0.9rem;">Date Filed</th>
                            <th style="padding: 0.75rem 0.5rem; color: var(--muted); font-weight: 600; font-size: 0.9rem;">Project Name</th>
                            <th style="padding: 0.75rem 0.5rem; color: var(--muted); font-weight: 600; font-size: 0.9rem;">Request Amount</th>
                            <th style="padding: 0.75rem 0.5rem; color: var(--muted); font-weight: 600; font-size: 0.9rem;">Status</th>
                        </tr>
                    </thead>
                    <tbody style="font-size: 0.95rem;" id="app-list">
                       <!-- Mock Data -->
                       <tr style="border-bottom: 1px solid var(--border);">
                           <td style="padding: 1rem 0.5rem;">Jan 20, 2026</td>
                           <td style="padding: 1rem 0.5rem; font-weight: 600;">Community Garden Expansion</td>
                           <td style="padding: 1rem 0.5rem;">$25,000</td>
                           <td style="padding: 1rem 0.5rem;"><span style="color: #d97706; background: #fffbeb; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; font-weight: 700;">Under Review</span></td>
                       </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Intake Form -->
        <div class="card" style="grid-column: 1 / -1; margin-top: 2rem;">
            <h3>Start New Request (Intake)</h3>
            <p style="margin-bottom: 1.5rem; color: var(--muted);">Please provide preliminary details for your funding request.</p>
            
            <form id="intake-form" class="contact-form">
                <div class="form-field">
                    <label for="project-name">Project / Request Title</label>
                    <input id="project-name" name="project-name" type="text" required placeholder="e.g. Small Business Startup Capital" />
                </div>

                <div class="owner-grid"> 
                    <div class="form-field">
                        <label for="amount">Requested Amount ($)</label>
                        <input id="amount" name="amount" type="number" required placeholder="50000" />
                    </div>
                     <div class="form-field">
                        <label for="timeline">Funding Needed By</label>
                        <input id="timeline" name="timeline" type="date" required />
                    </div>
                </div>

                <div class="form-field">
                    <label for="description">Description of Need</label>
                    <textarea id="description" name="description" rows="4" placeholder="Describe what the funds will be used for..." required></textarea>
                </div>

                <div class="form-field">
                    <label for="credit-score">Estimated Credit Score (Optional)</label>
                    <select id="credit-score" name="credit-score">
                        <option value="">Select Range</option>
                        <option value="excellent">Excellent (720+)</option>
                        <option value="good">Good (690-719)</option>
                        <option value="fair">Fair (630-689)</option>
                        <option value="poor">Needs Improvement (<629)</option>
                    </select>
                </div>

                <div class="form-field">
                    <label for="docs-link">Link to Business Plan / Supporting Docs (Drive, Dropbox)</label>
                    <input id="docs-link" name="docs-link" type="url" placeholder="https://" />
                </div>

                <button class="button button-primary" type="submit">Submit Request</button>
            </form>
        </div>
      </div>
      </div>

    <!-- TAB 2: MESSAGES -->
    <div id="view-messages" class="dash-view">
         <div class="section-heading">
            <h2>Message Center</h2>
            <p>Direct communication with your Grant Consultant.</p>
        </div>
        <div class="card" style="height: 60vh; padding: 0; display: flex; flex-direction: column;">
             <div id="client-chat-window" style="flex: 1; padding: 1.5rem 1.5rem 0.5rem; overflow-y: auto; background: var(--surface); display: flex; flex-direction: column; gap: 1rem;">
                 <!-- Messages -->
             </div>
             <div id="client-typing-indicator" class="typing-indicator">Consultant is typing...</div>
             <div style="padding: 1rem; border-top: 1px solid var(--border); background: #fff; display: flex; gap: 0.5rem; align-items: center;">
                 <button class="button button-ghost" style="padding: 0.5rem 0.75rem;" onclick="document.getElementById('client-file-input').click()" title="Upload File">
                    ðŸ“Ž
                 </button>
                 <input type="file" id="client-file-input" style="display: none;" onchange="handleClientFileUpload(this)">
                 <input id="client-chat-input" type="text" class="chat-input" placeholder="Type a message..." onkeydown="if(event.key === 'Enter') sendClientMessage()">
                 <button class="button button-primary" onclick="sendClientMessage()">Send</button>
             </div>
        </div>
    </div>
    </main>
    </div>

    <script>
        const name = sessionStorage.getItem("clientName");
        if (name) {
            document.getElementById("user-name").textContent = name;
        }

        // TAB SWITCHING
        function switchClientTab(tabName) {
            document.querySelectorAll('.dash-view').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + tabName).classList.add('active');
            
            const navLinks = document.querySelectorAll('.dash-link');
            navLinks.forEach(el => el.classList.remove('active'));
            if(tabName === 'dashboard') navLinks[0].classList.add('active');
            if(tabName === 'messages') {
                navLinks[1].classList.add('active');
                
                // Mark as read
                const clientName = sessionStorage.getItem("clientName") || "Unknown Client";
                const allMsgs = JSON.parse(localStorage.getItem("siteMessages") || "{}");
                if(allMsgs[clientName]) {
                    let changed = false;
                    allMsgs[clientName].forEach(m => {
                        if(m.sender === 'Admin' && !m.read) {
                            m.read = true;
                            changed = true;
                        }
                    });
                    if(changed) localStorage.setItem("siteMessages", JSON.stringify(allMsgs));
                }

                renderClientChat();
                updateClientBadge(); // Update UI
            }
        }

        // CHAT LOGIC
        function renderClientChat() {
            const clientName = sessionStorage.getItem("clientName") || "Unknown Client";
            const allMsgs = JSON.parse(localStorage.getItem("siteMessages") || "{}");
            const msgs = allMsgs[clientName] || [];
            
            const window = document.getElementById('client-chat-window');
            window.innerHTML = '';
            
            if(msgs.length === 0) {
                 window.innerHTML = `<p style="color:var(--muted); text-align: center; margin-top: 2rem;">No messages yet.</p>`;
            }

            msgs.forEach(m => {
                const isMe = m.sender === 'Client';
                const div = document.createElement('div');
                div.className = `message ${isMe ? 'sent' : 'received'}`;
                 // Admin messages show name
                const label = isMe ? '' : `<strong style="font-size: 0.75rem; display: block; margin-bottom: 2px;">Consultant</strong>`;
                div.innerHTML = `${label}${m.text} <span class="message-meta">${m.time}</span>`;
                window.appendChild(div);
            });
            window.scrollTop = window.scrollHeight;
        }

        function updateClientBadge() {
             const clientName = sessionStorage.getItem("clientName") || "Unknown Client";
             const allMsgs = JSON.parse(localStorage.getItem("siteMessages") || "{}");
             const msgs = allMsgs[clientName] || [];
             const unread = msgs.filter(m => m.sender === 'Admin' && !m.read).length;
             
             const link = document.getElementById('nav-msgs');
             // Preserve text, update badge
             link.innerHTML = `Message Center ${unread > 0 ? `<span class="badge">${unread}</span>` : ''}`;
        }
        
        // Typing Logic
        let typingTimeout;
        const clientInput = document.getElementById('client-chat-input');
        
        clientInput.addEventListener('input', () => {
             const clientName = sessionStorage.getItem("clientName") || "Unknown Client";
             localStorage.setItem('typing_' + clientName + '_client', 'true');
             clearTimeout(typingTimeout);
             typingTimeout = setTimeout(() => {
                 localStorage.setItem('typing_' + clientName + '_client', 'false');
             }, 1500);
        });
        
        // Listen for admin typing & new messages
        window.addEventListener('storage', (e) => {
             const clientName = sessionStorage.getItem("clientName") || "Unknown Client";
             
             if(e.key === 'siteMessages') {
                 // If we are currently looking at messages, refresh them. 
                 // If not, update badge.
                 const isChatOpen = document.getElementById('view-messages').classList.contains('active');
                 if(isChatOpen) {
                     // Since we are open, we should technically mark them as read immediately or let next click do it.
                     // For smoother UX, let's just render. User will likely click/type effectively clearing it.
                     // Or re-run switchClientTab('messages') logic?
                     renderClientChat();
                 } else {
                     updateClientBadge(); // Increment badge
                 }
             }

             if (e.key === 'typing_' + clientName + '_admin') {
                const indicator = document.getElementById('client-typing-indicator');
                if(e.newValue === 'true') indicator.classList.add('active');
                else indicator.classList.remove('active');
             }
        });

        // Polling (for single browser demo)
        setInterval(() => {
             const clientName = sessionStorage.getItem("clientName") || "Unknown Client";
             if(localStorage.getItem('typing_' + clientName + '_admin') === 'true') {
                 document.getElementById('client-typing-indicator').classList.add('active');
             } else {
                 document.getElementById('client-typing-indicator').classList.remove('active');
             }
             
             // Check badges frequently
             updateClientBadge();
             
             // Reload chat if open and changed
             if(document.getElementById('view-messages').classList.contains('active')) {
                  const currentMsgs = localStorage.getItem("siteMessages");
                  if (currentMsgs !== window.lastKnownMsgs) {
                     window.lastKnownMsgs = currentMsgs;
                     // Auto-mark read if active? 
                     // Let's keep it simple: just render.
                     renderClientChat();
                 }
             }
        }, 1000);

        function sendClientMessage() {
            const clientName = sessionStorage.getItem("clientName") || "Unknown Client";
            const input = document.getElementById('client-chat-input');
            const text = input.value.trim();
            if(!text) return;
            
            saveMessage(clientName, text);
            input.value = '';
            localStorage.setItem('typing_' + clientName + '_client', 'false');
        }

        function handleClientFileUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const clientName = sessionStorage.getItem("clientName") || "Unknown Client";
                const msg = `Shared a file: <br><a href="#" style="color: var(--primary); text-decoration: underline;">ðŸ“„ ${file.name}</a>`;
                
                saveMessage(clientName, msg);
                input.value = ''; // Reset
            }
        }

        function saveMessage(clientName, text) {
            const allMsgs = JSON.parse(localStorage.getItem("siteMessages") || "{}");
            if(!allMsgs[clientName]) allMsgs[clientName] = [];
            
            const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            allMsgs[clientName].push({ sender: 'Client', text: text, time: now, read: false }); // Unread by admin
            
            localStorage.setItem("siteMessages", JSON.stringify(allMsgs));
            renderClientChat();
        }


        const form = document.getElementById("intake-form");
        const appList = document.getElementById("app-list");

        // Load existing requests from LocalStorage
        const loadRequests = () => {
             const requests = JSON.parse(localStorage.getItem("clientRequests") || "[]");
             // Filter for this user in a real app, but for now show all or just ours. 
             // Since we don't have real auth, we'll just show the most recent ones stored.
             
             appList.innerHTML = ""; // Clear current mock data
             
             if (requests.length === 0) {
                 appList.innerHTML = `<tr><td colspan="4" style="padding: 1rem; text-align: center; color: var(--muted);">No active applications found.</td></tr>`;
                 return;
             }

             requests.forEach((req, index) => {
                 const row = document.createElement("tr");
                 row.style.borderBottom = "1px solid var(--border)";
                 
                 let statusColor = "var(--primary)";
                 let statusBg = "#f0fdf4";
                 
                 if (req.status === "Reviewing") { statusColor = "#d97706"; statusBg = "#fffbeb"; }
                 if (req.status === "Action Needed") { statusColor = "#dc2626"; statusBg = "#fef2f2"; }

                 row.innerHTML = `
                    <td style="padding: 1rem 0.5rem;">${req.date}</td>
                    <td style="padding: 1rem 0.5rem; font-weight: 600;">${req.projectName}</td>
                    <td style="padding: 1rem 0.5rem;">$${Number(req.amount).toLocaleString()}</td>
                    <td style="padding: 1rem 0.5rem;"><span style="color: ${statusColor}; background: ${statusBg}; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; font-weight: 700;">${req.status}</span></td>
                `;
                appList.appendChild(row);
             });
        };
        
        loadRequests();

        form.addEventListener("submit", (e) => {
            e.preventDefault();
            
            const pName = form["project-name"].value;
            const pAmount = form["amount"].value;
            const today = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            
            // Create new request object
            const newRequest = {
                id: Date.now(),
                clientName: sessionStorage.getItem("clientName") || "Unknown Client",
                date: today,
                projectName: pName,
                amount: pAmount,
                status: "Received",
                description: form["description"].value
            };

            // Save to LocalStorage
            const requests = JSON.parse(localStorage.getItem("clientRequests") || "[]");
            requests.unshift(newRequest); // Add to top
            localStorage.setItem("clientRequests", JSON.stringify(requests));

            loadRequests(); // Refresh table
            form.reset();
            alert("Application submitted successfully!");
        });
    </script>
  </body>
</html>
